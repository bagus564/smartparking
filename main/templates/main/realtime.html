{% extends "headfoot.html" %}
{% load static %}
{% block content %}
<title>Realtime</title>
<div class="text-center mt-8 mb-10">
    <h5 class="text-3xl font-bold text-[#141E61]">REAL TIME SMART PARKING</h5>
</div>

<div class="my-4 border-4 border-[#141E61] rounded-lg shadow-[0_5px_5px_rgba(0,0,0,0.2)]">
    <div class="md:p-4 p-2 text-center flex justify-center md:text-2xl text-md bg-[#141E61] font-medium text-white">
        Where would you like to park?
    </div>

    <div class="overflow-x-auto py-6">

        <!-- ========================= -->
        <!-- BAGIAN LEFT COLUMN -->
        <!-- ========================= -->
        <div class="grid grid-cols-2 md:grid-cols-5 xl:grid-cols-10 gap-4 mb-8">
            {% for slot in left_row %}
                <div id="slot-{{ slot.spot_number }}" class="flex flex-col items-center">
                    <div class="status-container w-[120px] h-[120px] rounded-2xl flex items-center justify-center shadow-md
                        {% if slot.status == 'Terisi' %} bg-red-500
                        {% elif slot.status == 'Kosong' %} bg-green-500
                        {% else %} bg-gray-400 {% endif %}">
                        
                        <img src="{% static 'main/car1.png' %}" alt="Car" class="w-10">
                    </div>

                    <div class="text-center mt-2">
                        <div class="font-semibold text-xs text-[#141E61]">Slot {{ slot.spot_number }}</div>
                        <div class="status-text text-xs font-semibold
                            {% if slot.status == 'Terisi' %} text-red-500 
                            {% elif slot.status == 'Kosong' %} text-green-500
                            {% else %} text-gray-500 {% endif %}">
                            
                            {% if slot.status == 'Terisi' %}
                                Terisi
                            {% elif slot.status == 'Kosong' %}
                                Kosong
                            {% else %}
                                Perbaikan/Acara
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- ========================= -->
        <!-- BAGIAN RIGHT COLUMN -->
        <!-- ========================= -->
        <div class="grid grid-cols-2 md:grid-cols-5 xl:grid-cols-10 gap-4">
            {% for slot in right_row %}
                <div id="slot-{{ slot.spot_number }}" class="flex flex-col items-center">
                    <div class="status-container w-[120px] h-[120px] rounded-2xl flex items-center justify-center shadow-md
                        {% if slot.status == 'Terisi' %} bg-red-500
                        {% elif slot.status == 'Kosong' %} bg-green-500
                        {% else %} bg-gray-400 {% endif %}">
                        
                        <img src="{% static 'main/car2.png' %}" alt="Car" class="w-10">
                    </div>

                    <div class="text-center mt-2">
                        <div class="font-semibold text-xs text-[#141E61]">Slot {{ slot.spot_number }}</div>
                        <div class="status-text text-xs font-semibold
                            {% if slot.status == 'Terisi' %} text-red-500 
                            {% elif slot.status == 'Kosong' %} text-green-500
                            {% else %} text-gray-500 {% endif %}">
                            
                            {% if slot.status == 'Terisi' %}
                                Terisi
                            {% elif slot.status == 'Kosong' %}
                                Kosong
                            {% else %}
                                Perbaikan/Acara
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

    </div>
</div>

<div class="mt-10 w-[90%] max-w-5xl mx-auto">
    
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-8">
        
        <div class="mt-6 lg:mt-0 flex-shrink-0">
            <h3 class="text-lg font-bold mb-4 text-[#141E61]">KETERANGAN STATUS</h3>
            <ul class="text-sm bg-white p-6 rounded-md shadow-md space-y-2 border-l-4 border-[#141E61]">
                <li><span class="inline-block w-5 h-5 bg-green-500 mr-2 rounded-sm"></span> Hijau: Kosong</li>
                <li><span class="inline-block w-5 h-5 bg-red-500 mr-2 rounded-sm"></span> Merah: Terisi</li>
                <li><span class="inline-block w-5 h-5 bg-gray-400 mr-2 rounded-sm"></span> Abu-abu: Perbaikan/Acara</li>
            </ul>
        </div>

        <div class="w-full lg:w-3/5">
    <h3 class="text-lg font-bold mb-4 text-[#141E61]">INFORMASI ACARA & PEMELIHARAAN</h3>

    <div id="announcementContainer">
        <p class="text-gray-500">Memuat pengumuman...</p>
    </div>
</div>

<script>
function loadAnnouncements() {  
    // Panggil API yang hanya mengembalikan pengumuman yang sedang AKTIF
    fetch('{% url "get_active_announcements" %}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("announcementContainer");
            container.innerHTML = "";

            if (data.announcements.length === 0) {
                container.innerHTML = "<p class='text-gray-500'>Belum ada pengumuman hari ini.</p>";
                return;
            }

            data.announcements.forEach(ann => {
                // Logika mapping warna seperti yang Anda buat
                const colorMap = {
                    yellow: 'border-yellow-500',
                    red: 'border-red-500',
                    gray: 'border-gray-400'
                };

                const div = document.createElement("div");
                div.className = 
                    "bg-white p-4 rounded-md shadow-md mb-4 border-l-4 " +
                    colorMap[ann.label_color];

                div.innerHTML = `
                    <h4 class="font-semibold text-[#141E61]">${ann.title}</h4>
                    ${ann.description ? `<p class='text-sm text-gray-700'>${ann.description}</p>` : ''}
                    <p class="text-sm text-gray-600 mt-1">
                        Tanggal: ${ann.start_date} – ${ann.end_date}
                    </p>
                    <p class="text-sm text-gray-600">
                        Slot parkir: ${ann.slot_numbers}
                    </p>
                `;
                container.appendChild(div);
            });
        })
        .catch(error => console.error("Error loading announcements:", error));
}

loadAnnouncements();
setInterval(loadAnnouncements, 2000);
</script>

    </div>
    </div>

<!-- ========================= -->
<!-- SCRIPT AUTO REFRESH -->
<!-- ========================= -->
<script>
function updateParkingStatus() {
    fetch('{% url "realtime_data" %}')
        .then(response => response.json())
        .then(data => {
            data.forEach(slot => {
                const element = document.getElementById(`slot-${slot.spot_number}`);
                if (!element) return;

                const statusBox = element.querySelector('.status-container');
                const statusText = element.querySelector('.status-text');

                statusBox.classList.remove('bg-red-500','bg-green-500','bg-gray-400');
                statusText.classList.remove('text-red-500','text-green-500','text-gray-500');

                let txt = "Perbaikan/Acara";

                if (slot.status === "Terisi") {
                    statusBox.classList.add('bg-red-500');
                    statusText.classList.add('text-red-500');
                    txt = "Terisi";
                }
                else if (slot.status === "Kosong") {
                    statusBox.classList.add('bg-green-500');
                    statusText.classList.add('text-green-500');
                    txt = "Kosong";
                }
                else {
                    statusBox.classList.add('bg-gray-400');
                    statusText.classList.add('text-gray-500');
                }

                statusText.textContent = txt;
            });
        })
        .catch(err => console.error("Realtime update error:", err));
}

updateParkingStatus();
setInterval(updateParkingStatus, 2000);
</script>

{% endblock %}
