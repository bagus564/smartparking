{% extends "admin_base.html" %}
{% load static %}

{% block akun_content %}
<title>All Reservations</title>

<!-- Navigation Tabs -->
<div class="flex flex-row mt-4 gap-2">
    <a href="{% url 'adminhome' %}"
       class="focus:outline-none text-[#141E61] bg-white hover:bg-[#141E61] hover:text-white font-medium rounded-2xl text-sm md:text-md px-4 md:px-8 py-2 shadow-md transition-all">
       Current Reservation
    </a>
    <a href="{% url 'adminmonitoring' %}"
       class="focus:outline-none text-[#141E61] bg-white hover:bg-[#141E61] hover:text-white font-medium rounded-2xl text-sm md:text-md px-4 md:px-8 py-2 shadow-md transition-all">
       Park Monitoring
    </a>
    <div>
        <a href="{% url 'adminrealtime' %}" class="focus:outline-none text-[#141E61] bg-white hover:bg-[#141E61] hover:text-white focus:ring-2 font-medium rounded-2xl md:text-md text-sm md:px-8 px-2 py-2 shadow-md me-2 mb-2 transition-all ease-in duration-300">Park RealTime</a>
    </div>
    <a href="#"
       class="focus:outline-none text-white bg-[#141E61] font-medium rounded-2xl text-sm md:text-md px-4 md:px-8 py-2 shadow-md transition-all">
       All Reservations
    </a>
</div>

<!-- Main Card -->
<div class="mt-6 bg-white rounded-2xl shadow-md animate-fade-up">
    <div class="md:px-12 px-6 pt-8">
        <h2 class="text-[clamp(20px,4vw,30px)] text-[#141E61] font-semibold underline">
            Reservations Management
        </h2>
    </div>

    <!-- Add export + toggle buttons inside the card header area -->
    <div class="mt-6 bg-white rounded-2xl shadow-md animate-fade-up p-6">
      <div class="flex justify-between items-center mb-4">
        <div>
          <label class="mr-2">From:</label>
          <input id="from-date" class="datepicker border rounded px-3 py-2" placeholder="Start date" readonly>
          <label class="mx-2">To:</label>
          <input id="to-date" class="datepicker border rounded px-3 py-2" placeholder="End date" readonly>
        </div>

        <div class="flex items-center gap-2">
          <button id="exportBtn" class="bg-white text-[#141E61] border rounded-2xl px-4 py-2 shadow">Export CSV</button>
        
        </div>
      </div>

      <!-- Table -->
      <div class="relative overflow-x-auto border border-[#0F044C] rounded-2xl md:mx-6 mx-2 mb-6 shadow-md">
          <table class="w-full text-sm text-center text-gray-700">
              <thead class="bg-[#F2F2F2] border-b border-[#0F044C] text-xs text-[#0F044C] uppercase">
                  <tr>
                      <th class="px-6 py-3">Username</th>
                      <th class="px-6 py-3">Date</th>
                      <th class="px-6 py-3">Time</th>
                      <th id="slotFilterBtn" class="px-6 py-3 relative cursor-pointer hover:underline inline-flex items-center gap-1">
                          Slot
                          <svg fill="#0F044C" class="w-5 h-5" viewBox="-6.5 0 32 32"><path d="M18.813 11.406l-7.906 9.906c-0.75 0.906-1.906 0.906-2.625 0l-7.906-9.906c-0.75-0.938-0.375-1.656 0.781-1.656h16.875c1.188 0 1.531 0.719 0.781 1.656z"></path></svg>
                      </th>
                      <th class="px-6 py-3">Phone</th>
                      <th class="px-6 py-3">Car Details</th>
                      <th class="px-6 py-3">Actions</th>
                  </tr>
              </thead>

              <tbody id="tableBody">
                  {% for reservation in reservations %}
                  <tr class="bg-white hover:bg-gray-50 border-b last:border-none" data-date="{{ reservation.start_time|date:'Y-m-d' }}">
                      <td class="px-6 py-4 font-medium text-gray-900">{{ reservation.user.username }}</td>
                      <td class="px-6 py-4">{{ reservation.start_time|date:"l, d F" }}</td>
                      <td class="px-6 py-4">{{ reservation.start_time|time:"H:i" }} - {{ reservation.end_time|time:"H:i" }}</td>
                      <td class="px-6 py-4">{{ reservation.spot_id }}</td>
                      <td class="px-6 py-4">{{ reservation.user.phone_number }}</td>

                      <!-- Car Modal -->
                      <td class="px-6 py-4">
                          <button type="button" data-modal-target="view{{ reservation.id }}" data-modal-toggle="view{{ reservation.id }}"
                                  class="text-white bg-blue-700 hover:bg-blue-900 rounded-xl px-4 py-2 shadow-md transition-all">
                              View
                          </button>

                          <div id="view{{ reservation.id }}" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30">
                              <div class="bg-white rounded-lg w-full max-w-md shadow-lg overflow-hidden">
                                  <div class="flex items-center justify-between p-4 border-b">
                                      <h3 class="text-xl font-semibold text-gray-900">Car Details</h3>
                                      <button data-modal-hide="view{{ reservation.id }}" class="text-gray-400 hover:text-gray-700">
                                          âœ•
                                      </button>
                                  </div>
                                  <div class="p-5 grid grid-cols-2 gap-4 text-sm">
                                      <div><span class="text-gray-500">Brand:</span><p class="p-2 bg-gray-100 rounded-lg">{{ reservation.car.brand }}</p></div>
                                      <div><span class="text-gray-500">Model:</span><p class="p-2 bg-gray-100 rounded-lg">{{ reservation.car.model }}</p></div>
                                      <div><span class="text-gray-500">Color:</span><p class="p-2 bg-gray-100 rounded-lg">{{ reservation.car.color }}</p></div>
                                      <div><span class="text-gray-500">Plate:</span><p class="p-2 bg-gray-100 rounded-lg">{{ reservation.car.license_plate }}</p></div>
                                  </div>
                                  <div class="p-4 flex flex-col items-center">
                                      <span class="text-gray-500 text-sm mb-2">Car Image:</span>
                                      <img src="{{ reservation.car.image.url }}" alt="Car Image" class="w-32 h-auto rounded-md shadow-sm">
                                  </div>
                                  <div class="p-4">
                                      <button data-modal-hide="view{{ reservation.id }}" class="w-full py-2 text-white bg-blue-700 rounded-xl hover:bg-blue-900 transition-all">
                                          OK
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </td>

                      <!-- Cancel Modal -->
                      <td class="px-6 py-4">
                          <button type="button" data-modal-target="cancel{{ reservation.id }}" data-modal-toggle="cancel{{ reservation.id }}"
                                  class="text-white bg-red-700 hover:bg-red-900 rounded-xl px-4 py-2 shadow-md transition-all">
                              Cancel
                          </button>

                          <form action="{% url 'delete_reservation' reservation.id %}?next=adminreservation" method="POST">
                              {% csrf_token %}
                              <div id="cancel{{ reservation.id }}" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30">
                                  <div class="bg-white rounded-lg w-full max-w-md shadow-lg overflow-hidden text-center">
                                      <div class="p-5">
                                          <svg class="mx-auto mb-4 text-gray-400 w-12 h-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
                                          <h3 class="mb-5 text-gray-600">Are you sure you want to cancel this reservation?</h3>
                                          <div class="grid grid-cols-2 gap-4">
                                              <button type="submit" class="py-2 bg-red-700 text-white rounded-lg hover:bg-red-900">Yes</button>
                                              <button data-modal-hide="cancel{{ reservation.id }}" type="button" class="py-2 bg-gray-100 text-gray-900 rounded-lg hover:bg-gray-200">No</button>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </form>
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
    </div>
</div>

<!-- Scripts -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
flatpickr("#from-date", { dateFormat: "Y-m-d" });
flatpickr("#to-date", { dateFormat: "Y-m-d" });

// CSRF helper
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
const csrftoken = getCookie('csrftoken');

// Export CSV handler
document.getElementById("exportBtn").addEventListener("click", function () {
    const from = encodeURIComponent(document.getElementById('from-date').value || '');
    const to = encodeURIComponent(document.getElementById('to-date').value || '');
    let url = "{% url 'export_reservations' %}";
    const params = [];
    if (from) params.push('from=' + from);
    if (to) params.push('to=' + to);
    if (params.length) url += '?' + params.join('&');
    window.location.href = url;
});

// Toggle slots button state init
const toggleBtn = document.getElementById('toggleSpotsBtn');
const stateUrl = "{% url 'spots_state' %}";
const toggleUrl = "{% url 'toggle_all_spots_disable' %}";

fetch(stateUrl, { credentials: 'same-origin' })
  .then(r => r.json())
  .then(data => {
    if (data.all_disabled) toggleBtn.textContent = 'Enable All Slots';
    else toggleBtn.textContent = 'Disable All Slots';
  })
  .catch(() => toggleBtn.textContent = 'Toggle Slots');

// Toggle action
toggleBtn.addEventListener('click', function () {
  if (!confirm('Are you sure? This will toggle all slots.')) return;
  toggleBtn.disabled = true;
  toggleBtn.textContent = 'Processing...';

  fetch(toggleUrl, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Accept': 'application/json'
    },
    credentials: 'same-origin'
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      if (data.state === 'disabled') toggleBtn.textContent = 'Enable All Slots';
      else toggleBtn.textContent = 'Disable All Slots';
      alert('Slots updated: ' + data.state);
    } else {
      alert('Update failed: ' + (data.error || 'unknown'));
    }
  })
  .catch(err => {
    console.error(err);
    alert('Request error');
  })
  .finally(() => { toggleBtn.disabled = false; });
});
</script>

{% endblock %}
