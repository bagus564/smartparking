{% extends "headfoot.html" %}

{% block title %}Home Page{% endblock %}

{% load static %}

{% block content %}
<title>Reservation</title>
<div class="md:pl-16 py-1 md:pt-12 pt-8 md:text-left text-center">
    <span class="md:text-[50px] text-[35px] text-[#141E61] md:text-[clamp(34px,4vw,50px)]">
        Reserve Your Spot
    </span>
</div>

<div class="flex pb-4 animate-fade-up md:pb-8 flex-col md:flex-row mb-12 ">

    <div class=" flex-col flex md:w-2/5 md:order-1 order-2">
        <div class="md:px-12 px-8 md:my-20 my-4 md:mx-12 flex flex-col">
        <form action="" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div >
                <span class="text-gray-500 text-lg">Date :</span>
                <input readonly type="text" name="date" id="default-date" class="bg-gray-100 border border-gray-400 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 " required>
            </div>

            <div class="my-6"> Â  
                <span class="text-gray-500 text-lg">Parking Slot :</span>
                <select required id="slot" name="slot" class=" bg-white border border-gray-400 text-[#0F044C] text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">
                    <option selected disabled hidden value="" >Choose Slot</option>
                    <option value="1">Slot 1</option>
                    <option value="2">Slot 2</option>
                    <option value="3">Slot 3</option>
                    <option value="4">Slot 4</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <span class="text-gray-500 text-lg">From :</span>
                    <select required id="start" name="start_time" class="bg-white border border-gray-400 text-[#0F044C] text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <option value="" disabled selected hidden></option>
                    </select>
                </div>
                <div>
                    <span class="text-gray-500 text-lg">Until :</span>
                        <select required id="end" name="end_time" class=" bg-white border border-gray-400 text-[#0F044C] text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">
                            <option selected disabled hidden ></option>
                            <option value="07:00">07:00</option>
                            <option value="07:30">07:30</option>
                            <option value="08:00">08:00</option>
                            <option value="08:30">08:30</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="12:00">12:00</option>
                            <option value="12:30">12:30</option>
                            <option value="13:00">13:00</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            <option value="17:00">17:00</option>
                            <option value="17:30">17:30</option>
                            <option value="18:00">18:00</option>
                            <option value="18:30">18:30</option>
                            <option value="19:00">19:00</option>
                            <option value="19:30">19:30</option>
                            <option value="20:00">20:00</option>
                            <option value="20:30">20:30</option>
                            <option value="21:00">21:00</option>
                            <option value="21:30">21:30</option>
                            <option value="22:00">22:00</option>
                            <option value="22:30">22:30</option>
                            <option value="23:00">23:00</option>
                        </select>
                </div>
                </div>

                <div id="car_form" class="grid grid-cols-2 gap-4 ">
                    <div class="mr-0">
                        <label for="brand" class="block mb-2 text-sm font-medium text-gray-600">Brand:</label>
                        <select name="dropdown1" id="id_dropdown1" class="bg-white border border-[#0F044C] text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="" class="hidden">Choose</option>
                    <option value="Audi">Audi</option>
                    <option value="BMW">BMW</option>
                    <option value="BYD">BYD</option>
                    <option value="Chery">Chery</option>
                    <option value="Chevrolet">Chevrolet</option>
                    <option value="Daihatsu">Daihatsu</option>
                    <option value="Ford">Ford</option>
                    <option value="Honda">Honda</option>
                    <option value="Hyundai">Hyundai</option>
                    <option value="Isuzu">Isuzu</option>
                    <option value="Jaguar">Jaguar</option>
                    <option value="Kia">Kia</option>
                    <option value="Land Rover">Land Rover</option>
                    <option value="Lexus">Lexus</option>
                    <option value="Mercedes-Benz">Mercedes-Benz</option>
                    <option value="MG">MG</option>
                    <option value="Mini">Mini</option>
                    <option value="Mitsubishi">Mitsubishi</option>
                    <option value="Nissan">Nissan</option>
                    <option value="Peugeot">Peugeot</option>
                    <option value="Porsche">Porsche</option>
                    <option value="Renault">Renault</option>
                    <option value="Subaru">Subaru</option>
                    <option value="Suzuki">Suzuki</option>
                    <option value="Tesla">Tesla</option>
                    <option value="Toyota">Toyota</option>
                    <option value="Volvo">Volvo</option>
                    <option value="Wuling">Wuling</option>
                </select>
                    </div>

                    <div class="mr-0">
                        <label for="model" class="block mb-2 text-sm font-medium text-gray-600">Model:</label>
                        <select name="dropdown2" id="id_dropdown2" class="bg-white border border-[#0F044C] text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </select>
                    </div>

                    <div class="mt-2 mr-0">
                        <label for="color" class="block mb-2 text-sm font-medium text-gray-600">Color:</label>
                        <select name="color" id="color" class="bg-white border border-[#0F044C] text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="" class="hidden"></option>
                            <option value="White">White</option>
                    <option value="Black">Black</option>
                    <option value="Silver">Silver</option>
                    <option value="Gray">Gray</option>
                    <option value="Red">Red</option>
                    <option value="Blue">Blue</option>
                    <option value="Brown">Brown</option>
                    <option value="Bronze">Bronze</option>
                    <option value="Green">Green</option>
                    <option value="Yellow">Yellow</option>
                </select>
                    </div>

                    <div class="mt-2 mr-0">
                        <label for="Plate" class="block mb-2 text-sm font-medium text-gray-600">Plate:</label>
                        <select name="plate1" id="plate1" class="bg-white border border-[#0F044C] text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="" disabled selected class="hidden">Kode</option>
                            {% include 'main/plate_options.html' %} 
                        </select>
                        <div class="mt-2 mr-0">
                            <input type="text" name="plate2" maxlength="3" class="bg-white border border-[#0F044C] text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="123" required>
                        </div>
                        <div class="mt-2 mr-0">
                            <input type="text" name="plate3" class="bg-white border border-[#0F044C] text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="XYZ" required>
                        </div>
                    </div>
                </div>

                <div class="w-full">
                    <label for="imageUpload" class="block mb-2 text-sm font-medium text-gray-600">Car Image:</label>
                    <input required class="block w-full text-sm text-gray-900 border border-[#0F044C] rounded-md cursor-pointer bg-white focus:outline-none" aria-describedby="file_input_help" type="file" name="imageUpload" id="imageUpload" accept=".jpg, .jpeg, .png, image/jpeg, image/png">
                    <p id="fileInfo" class="mt-2 text-sm text-red-600"></p>

                    <div class="justify-center flex items-center">
                        <img src="" alt="Image preview" id="preview_image" class="mt-4 hidden w-auto h-48 border border-gray-300 rounded">
                    </div>
                </div>
            
            <div class="mt-12">
                <button class="shadow-[0_5px_5px_rgba(0,0,0,0.2)] w-full block focus:outline-none text-white bg-[#141E61] hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-[50px] text-lg px-5 py-2.5 me-2 mb-2 text-center" type="submit">Reservasi</button>
            </div>

        </form>
        </div>
    </div>


    <div class="flex-col flex md:w-3/5 md:order-2 order-1">
    
    <div class="mx-4 px-2 mt-8 md:mt-0 md:mx-12 flex flex-col">

        <div class="flex justify-between items-center mb-4"> 
            
            <div class="text-[#0F044C] font-medium rounded-lg text-sm text-center inline-flex items-center">
                <input 
                    id="default-datepicker" 
                    name="date" 
                    type="text" 
                    data-datepicker 
                    data-date-format="mm/dd/yyyy" 
                    min="{{ today }}" 
                    max="{{ two_weeks }}" 
                    class="bg-white text-sm rounded-lg border border-2 border-[#141E61] md:px-4 px-2 py-1.5 placeholder-[#141E61] hover:bg-[#141E61] hover:placeholder-white cursor-pointer focus:ring-blue-500 focus:border-blue-500 w-auto" 
                    size="8" 
                    placeholder="Select date" 
                    readonly 
                />
            </div>

            <div class="me-4 mt-4"> 
                <button data-modal-target="view" data-modal-toggle="view" type="button" class="flex items-center text-xs text-blue-700 hover:text-blue-800 hover:underline">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="w-4 h-4" viewBox="0 0 256 256" xml:space="preserve">
                        </svg> View place
                </button>
            </div>
        </div>
        <div id="view" tabindex="-1" aria-hidden="true"
            class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 overflow-y-auto overflow-x-hidden">
            <div class="relative w-full max-w-4xl p-4">
                <div class="relative bg-white rounded-lg shadow-sm">
                    <div class="flex items-center justify-between p-4 border-b rounded-t">
                        <h3 class="text-xl font-semibold text-gray-900">
                            Parking lot view <span class="text-gray-500 text-sm">( TA Parking Lot )</span>
                        </h3>
                        <button type="button" data-modal-toggle="view" class="text-gray-400 hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center" >
                        </button>
                    </div>
                    <div class="p-4 flex flex-col items-center gap-4">
                        <div class="overflow-auto border rounded shadow max-w-full">
                            <img id="parkImage" src="{% static 'main/parkview.png' %}" alt="Parking lot image"
                                class="transition-transform duration-300 scale-100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class=" my-4 border border-4 border-[#141E61] rounded-lg shadow-[0_5px_5px_rgba(0,0,0,0.2)]">

            <div class="md:p-4 p-2 justify-center text-center flex md:text-3xl text-md bg-[#141E61] font-medium text-white">
                Where would you like to park?
            </div>

            {% include 'main/slot_modals.html' %}
            
        </div>
        </div>
    </div>
                    
                    <!-- ==================== JS ==================== -->
                   <script>
document.addEventListener('DOMContentLoaded', () => {
    // ==================== DOM Elements ==================== //
    const dateInput = document.getElementById('default-datepicker');
    const dateFormInput = document.getElementById('default-date'); // Asumsi ada elemen ini dari kode sebelumnya
    const spotInput = document.getElementById('slot');
    const startSelect = document.getElementById('start');
    const endSelect = document.getElementById('end');
    const dropdown1 = document.getElementById('id_dropdown1'); // Brand mobil
    const dropdown2 = document.getElementById('id_dropdown2'); // Model mobil
    const plateSelect = document.getElementById('plate1');
    const imageUpload = document.getElementById('imageUpload');
    const previewImage = document.getElementById('preview_image');
    const carForm = document.getElementById('car_form');
    
    let blockedIntervals = [];

    // ==================== Data & Shared Functions ==================== //
    const optionsMap = {
        "0": [""], "Audi": ["A4", "A6", "A8", "Q3", "Q5", "Q7", "e-tron"],
        "BMW": ["320i", "330i", "520i", "X1", "X3", "X5", "i4", "iX"],
        "BYD": ["Atto 3", "Dolphin", "Seal"], "Chery": ["Omoda 5", "Tiggo 7 Pro", "Tiggo 8 Pro"],
        "Chevrolet": ["Captiva", "Spin", "Trax"], "Daihatsu": ["Ayla", "Gran Max", "Rocky", "Sigra", "Terios", "Xenia"],
        "Ford": ["Everest", "Focus", "Ranger"], 
        "Honda": ["Accord", "BR-V", "Brio", "City", "City Hatchback", "Civic", "CR-V", "HR-V", "Mobilio"],
        "Hyundai": ["Creta", "Ioniq 5", "Kona EV", "Palisade", "Santa Fe", "Stargazer"],
        "Isuzu": ["D-Max", "MU-X", "Panther"], "Jaguar": ["F-Pace", "I-Pace", "XE", "XF"],
        "Kia": ["Carens", "EV6", "Seltos", "Sonet"],
        "Land Rover": ["Defender", "Range Rover Evoque", "Range Rover Sport", "Range Rover Velar"],
        "Lexus": ["ES", "NX", "RX", "RZ", "UX"],
        "Mercedes-Benz": ["C200", "C300", "E200", "EQB", "EQS", "GLA", "GLC", "GLE"],
        "MG": ["4 EV", "5 GT", "ZS", "ZS EV"], "Mini": ["Cooper", "Countryman", "Electric"],
        "Mitsubishi": ["Pajero Sport", "Triton", "Xpander", "Xpander Cross"],
        "Nissan": ["Livina", "Magnite", "Serena", "X-Trail"], "Peugeot": ["2008", "3008", "5008"],
        "Porsche": ["911", "Cayenne", "Macan", "Taycan"], "Renault": ["Kwid", "Triber", "Zoe"],
        "Subaru": ["Forester", "WRX", "XV"], 
        "Suzuki": ["Baleno", "Carry", "Ertiga", "Ignis", "Jimny", "XL7"], 
        "Tesla": ["Model 3", "Model Y"],
        "Toyota": ["Agya", "Avanza", "Camry", "Fortuner", "Hilux", "Innova", "Land Cruiser", "Raize", "Rush", "Veloz", "Yaris"],
        "Volvo": ["EX30", "EX90", "XC40", "XC60", "XC90"], 
        "Wuling": ["Air EV", "Almaz", "Almaz RS", "Confero", "Cortez"]
    };

    function formatDateToISO(dateString) {
        if (!dateString) return '';
        const [month, day, year] = dateString.split('/');
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }

    function generateTimeOptions(isToday) {
        const options = [];
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        
        for (let hour = 7; hour <= 23; hour++) {
            for (let min = 0; min < 60; min += 30) {
                const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                const totalMinutes = hour * 60 + min;
                options.push({ value: timeStr, disabled: isToday && totalMinutes < currentMinutes });
            }
        }
        return options;
    }

    function isTimeInBlockedInterval(time, intervals) {
        const totalMinutes = time.split(':').map(Number).reduce((h, m) => h * 60 + m);
        for (const interval of intervals) {
            const blockStart = interval.start.split(':').map(Number).reduce((h, m) => h * 60 + m);
            const blockEnd = interval.end.split(':').map(Number).reduce((h, m) => h * 60 + m);
            if (totalMinutes >= blockStart && totalMinutes < blockEnd) return true;
        }
        return false;
    }
    
    // ==================== Core Fetch & Populate Logic ==================== //

    async function fetchBlockedIntervalsAndUpdate() {
        const date = dateInput.value;
        const spot = spotInput.value;

        if (!date || !spot) return;
        const formattedDate = formatDateToISO(date);
        
        try {
            const response = await fetch(`/api/reserved-intervals/?date=${formattedDate}&spot=${spot}`);
            if (!response.ok) throw new Error('Failed to fetch blocked intervals');
            const data = await response.json();
            populateTimeDropdowns(date, data.blocked_intervals);
        } catch (error) {
            console.error('Error fetching blocked intervals:', error);
            populateTimeDropdowns(date); // Populate tanpa data blocked
        }
    }

    function populateTimeDropdowns(selectedDateStr, intervals = []) {
        if (!startSelect || !endSelect) return;
        startSelect.innerHTML = '<option value="" disabled selected hidden>From</option>';
        endSelect.innerHTML = '<option value="" disabled selected hidden>Until</option>';
        endSelect.disabled = true;

        const now = new Date();
        const todayStr = `${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}/${now.getFullYear()}`;
        const isToday = selectedDateStr === todayStr;
        blockedIntervals = intervals;
        const timeOptions = generateTimeOptions(isToday);

        timeOptions.forEach(opt => {
            const isBlocked = isTimeInBlockedInterval(opt.value, intervals);
            
            // Start select
            const startOption = new Option(opt.value, opt.value);
            startOption.disabled = opt.disabled || isBlocked;
            if (startOption.disabled) startOption.classList.add('opacity-50');
            startSelect.appendChild(startOption);

            // End select - Awalnya semua terisi, validasi akan dilakukan di event listener 'change' startSelect
            const endOption = new Option(opt.value, opt.value);
            endOption.disabled = isBlocked;
            if (endOption.disabled) endOption.classList.add('opacity-50');
            endSelect.appendChild(endOption);
        });
    }

    // ==================== Event Listeners ==================== //

    // 1. Logic waktu
    if (startSelect && endSelect) {
        startSelect.addEventListener('change', () => {
            const selectedStart = startSelect.value;
            endSelect.selectedIndex = 0;
            endSelect.disabled = false; // Aktifkan endSelect

            if (!selectedStart) return;
            
            const startTotalMinutes = selectedStart.split(':').map(Number).reduce((h, m) => h * 60 + m);

            Array.from(endSelect.options).forEach(option => {
                if (!option.value) return;
                
                const endTotalMinutes = option.value.split(':').map(Number).reduce((h, m) => h * 60 + m);
                
                let isDisabled = false;
                
                // Nonaktifkan waktu sebelum waktu mulai atau sama
                if (endTotalMinutes <= startTotalMinutes) {
                    isDisabled = true;
                } else {
                    // Cek tabrakan reservasi
                    for (const interval of blockedIntervals) {
                        const blockStart = interval.start.split(':').map(Number).reduce((h, m) => h * 60 + m);
                        const blockEnd = interval.end.split(':').map(Number).reduce((h, m) => h * 60 + m);
                        
                        // Tabrakan jika: mulai baru sebelum akhir blok DAN akhir baru setelah mulai blok
                        if (startTotalMinutes < blockEnd && endTotalMinutes > blockStart) {
                            isDisabled = true;
                            break;
                        }
                    }
                }

                option.disabled = isDisabled;
                // Pastikan opsi yang terblokir di populateTimeDropdowns tetap terblokir
                if (option.classList.contains('opacity-50') && option.textContent === endSelect.value) {
                    isDisabled = true;
                }
                option.classList.toggle('opacity-50', isDisabled);
            });
        });
    }

    // 2. Datepicker Initialization & Fetch
    if (window.Datepicker && dateInput && spotInput) {
        // PERHATIAN: Asumsi variabel Django {{ today|escapejs }} dan {{ two_weeks|escapejs }} tersedia.
        const today = new Date("{{ today|escapejs }}"); 
        const maxDate = new Date("{{ two_weeks|escapejs }}");

        new Datepicker(dateInput, { format: 'mm/dd/yyyy', minDate: today, maxDate: maxDate, autohide: true });

        // Event saat tanggal dipilih
        dateInput.addEventListener('changeDate', (event) => {
            if (dateFormInput) dateFormInput.value = dateInput.value;
            fetchSlotStatusByDate(dateInput.value);
            
            // Tampilkan form mobil
            if (carForm) showCarForm();

            // Reset Waktu
            if (startSelect) startSelect.selectedIndex = 0;
            if (endSelect) { endSelect.selectedIndex = 0; endSelect.disabled = true; }
            if (spotInput.value) fetchBlockedIntervalsAndUpdate();
        });
        
        // Initial load
        if (dateInput.value) {
            fetchSlotStatusByDate(dateInput.value);
            if (spotInput.value) fetchBlockedIntervalsAndUpdate();
            if (carForm) showCarForm();
        } else {
            if (carForm) hideCarForm();
        }
    } else {
        console.error('Datepicker library not loaded or input missing');
    }

    if (spotInput) {
        // Event saat Slot berubah
        spotInput.addEventListener('change', fetchBlockedIntervalsAndUpdate);
    }
    
    // 3. Logic Form Mobil (Brand/Model)
    function updateDropdown2(brand) {
        if (!dropdown2) return;
        dropdown2.innerHTML = '<option value="" disabled selected hidden>Choose Model</option>';
        const models = optionsMap[brand] || optionsMap["0"];
        models.forEach(model => {
            const option = new Option(model.toUpperCase(), model);
            dropdown2.appendChild(option);
        });
    }

    if (dropdown1 && dropdown2) {
        dropdown1.addEventListener('change', () => updateDropdown2(dropdown1.value));
        if (dropdown1.value) updateDropdown2(dropdown1.value); // Initial load model
    }

    // 4. Logic Plat Nomor (Plate Code)
    if (plateSelect) {
        // Simpan data-label saat DOM loaded
        window.addEventListener('DOMContentLoaded', () => {
            Array.from(plateSelect.options).forEach(option => {
                option.setAttribute('data-label', option.textContent);
            });
            // Tampilkan hanya kode jika sudah terpilih
            const selectedOption = plateSelect.options[plateSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                selectedOption.textContent = selectedOption.value;
            }
        });

        // Ubah tampilan selected option menjadi hanya kode saat dipilih
        plateSelect.addEventListener('change', function () {
            Array.from(plateSelect.options).forEach(option => {
                 // Restore label untuk semua option di dropdown
                const label = option.getAttribute('data-label');
                if (label) option.textContent = label;
            });
            // Ubah teks yang terpilih
            const selectedOption = plateSelect.options[plateSelect.selectedIndex];
            selectedOption.textContent = selectedOption.value;
        });
    }

    // 5. Logic Pratinjau Gambar
    if (imageUpload && previewImage) {
        imageUpload.addEventListener('change', function () {
            const file = imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { previewImage.src = e.target.result; };
                reader.readAsDataURL(file);
            }
        });
    }

    // 6. Logic Animasi Form Mobil
    function showCarForm() {
        if (!carForm) return;
        carForm.classList.remove("max-h-0", "opacity-0");
        carForm.classList.add("max-h-[2000px]", "opacity-100");
    }

    function hideCarForm() {
        if (!carForm) return;
        carForm.classList.remove("max-h-[2000px]", "opacity-100");
        carForm.classList.add("max-h-0", "opacity-0");
    }
    
    // ==================== Slot Status & Real-time Update ==================== //

    function updateSlotDisplay(slotNumber, status) {
        const box = document.getElementById(`slot-${slotNumber}-box`);
        const label = document.getElementById(`slot-${slotNumber}-label`);
        const btn = document.getElementById(`slot-${slotNumber}-btn`);
        if (!box || !label || !btn) return;

        // Reset classes
        box.className = "md:py-8 justify-center items-center flex rounded-2xl md:h-auto h-[130px] md:mx-3 mx-1.5 mt-3";
        label.className = "text-md font-semibold";
    
        const option = spotInput.querySelector(`option[value="${slotNumber}"]`);
        if (option) option.disabled = (status === 'disabled' || status === 'occupied'); // Tambahkan occupied

        if (status === "occupied") {
            box.classList.add('bg-[#8a1616]');
            label.classList.add('text-[#8a1616]');
            label.innerText = "Occupied";
            btn.onclick = () => document.getElementById(`popup-modal${slotNumber}`).classList.remove('hidden');
        } else if (status === "reserved") {
            box.classList.add('bg-[#afd106]', 'opacity-75'); // Sedikit buram untuk Reserved
            label.classList.add('text-[#afd106]');
            label.innerText = "Reserved";
            btn.onclick = () => document.getElementById(`popup-modal${slotNumber}-reserved`).classList.remove('hidden');
        } else if (status === "disabled") {
            box.classList.add('bg-[#A0A0A0]');
            label.classList.add('text-[#A0A0A0]');
            label.innerText = "Disabled";
            btn.onclick = () => alert('This slot is disabled by admin.');
        } else { // Available
            box.classList.add('bg-[#018214]');
            label.classList.add('text-[#018214]');
            label.innerText = "Available";
            btn.onclick = () => window.setSlotDirectly(slotNumber);
        }
    }

    function fetchSlotStatusByDate(selectedDate) {
        if (!selectedDate) return;
        const formattedDate = formatDateToISO(selectedDate);
        fetch(`/api/spots-dynamic-status/?date=${formattedDate}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(spot => updateSlotDisplay(spot.spot_number, spot.status));
            })
            .catch(err => console.error('Error fetching slot status:', err));
    }
    
    // Real-time update setiap 3 detik
    setInterval(() => {
        if (dateInput && dateInput.value) {
            fetchSlotStatusByDate(dateInput.value);
        }
    }, 3000);

    // Fungsi global untuk slot selection (dipanggil dari button/click)
    window.setSlotDirectly = function(value) {
        if (spotInput) {
            spotInput.value = value;
            const option = spotInput.querySelector(`option[value="${value}"]`);
            if (option) option.selected = true;
            fetchBlockedIntervalsAndUpdate();
            // Asumsi ada fungsi highlightSelectedSlot dari kode yang lebih lengkap
            // highlightSelectedSlot(value); 
        }
    }
    
    // 7. Logic Modal Hiding
    document.querySelectorAll('[data-modal-hide]').forEach(btn => {
        btn.addEventListener('click', () => {
            const modalId = btn.getAttribute('data-modal-hide');
            document.getElementById(modalId).classList.add('hidden');
        });
    });
    
    document.querySelectorAll('.fixed').forEach(modal => {
        modal.addEventListener('click', e => {
            if (e.target === modal) modal.classList.add('hidden');
        })
    });

    // Global function untuk pesan error Django
    window.closeModal = function() {
        const errorModal = document.getElementById("errorModal");
        if (errorModal) errorModal.style.display = "none";
    }
});
</script>

{% endblock %}

